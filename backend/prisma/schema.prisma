generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum TripStatus {
  PLANNED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum ActivityCategory {
  SIGHTSEEING
  FOOD_DRINK
  ADVENTURE
  CULTURE
  SHOPPING
  NIGHTLIFE
  RELAXATION
  SPORTS
  TRANSPORTATION
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  password    String
  avatar      String?
  role        UserRole     @default(USER)
  status      UserStatus   @default(ACTIVE)
  lastLogin   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  itineraries Itinerary[]
  trips       Trip[]
  shareLinks  ShareLink[]

  @@map("users")
}

// ============================================
// TRIP MANAGEMENT (NEW - FOR FRONTEND)
// ============================================

model Trip {
  id              String         @id @default(cuid())
  userId          String
  name            String
  description     String?
  startDate       DateTime?
  endDate         DateTime?
  coverImageUrl   String?
  isPublic        Boolean        @default(false)
  status          TripStatus     @default(PLANNED)
  budget          Float?
  destinations    String[]       // Array of city names
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tripActivities  TripActivity[]
  shareLinks      ShareLink[]

  @@map("trips")
}

model City {
  id          String     @id @default(cuid())
  name        String
  country     String
  description String?
  imageUrl    String?
  costIndex   Float?     // 0-100 scale
  popularity  Int        @default(0)
  amadeusCode String?    @unique // IATA code from Amadeus
  latitude    Float?
  longitude   Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  activities  Activity[]

  @@map("cities")
}

model Activity {
  id                String           @id @default(cuid())
  cityId            String
  name              String
  description       String?
  category          ActivityCategory
  estimatedCost     Float?
  duration          Int?             // Duration in minutes
  imageUrl          String?
  amadeusActivityId String?          @unique
  rating            Float?
  bookingLink       String?
  latitude          Float?
  longitude         Float?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  city              City             @relation(fields: [cityId], references: [id], onDelete: Cascade)
  tripActivities    TripActivity[]

  @@map("activities")
}

model TripActivity {
  id         String   @id @default(cuid())
  tripId     String
  activityId String
  date       DateTime?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  trip       Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([tripId, activityId])
  @@map("trip_activities")
}

model ShareLink {
  id        String   @id @default(cuid())
  shareId   String   @unique // URL-safe random string
  tripId    String
  userId    String
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("share_links")
}

// ============================================
// LEGACY ITINERARY SYSTEM (KEEP FOR NOW)
// ============================================

model Itinerary {
  id            String           @id @default(cuid())
  userId        String
  name          String
  description   String?
  totalBudget   Float?
  currency      String           @default("USD")
  startDate     DateTime?
  endDate       DateTime?
  status        String           @default("planning")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  stops         ItineraryStop[]
  flights       FlightSegment[]
  budgetSummary BudgetSummary?

  @@map("itineraries")
}

model ItineraryStop {
  id             String              @id @default(cuid())
  itineraryId    String
  cityCode       String
  cityName       String
  countryCode    String?
  latitude       Float?
  longitude      Float?
  sequence       Int
  checkInDate    DateTime?
  checkOutDate   DateTime?
  nights         Int?
  notes          String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  
  itinerary      Itinerary           @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  activities     ItineraryActivity[]
  hotels         ItineraryHotel[]

  @@unique([itineraryId, sequence])
  @@map("itinerary_stops")
}

model ItineraryActivity {
  id                String        @id @default(cuid())
  stopId            String
  amadeusActivityId String
  name              String
  shortDescription  String?
  description       String?
  rating            Float?
  price             Float?
  currency          String?
  bookingLink       String?
  minimumDuration   String?
  pictures          String[]
  latitude          Float?
  longitude         Float?
  isBooked          Boolean       @default(false)
  bookingDate       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  stop              ItineraryStop @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@map("itinerary_activities")
}

model ItineraryHotel {
  id             String        @id @default(cuid())
  stopId         String
  amadeusHotelId String
  hotelName      String
  chainCode      String?
  offerId        String?
  roomType       String?
  checkInDate    DateTime
  checkOutDate   DateTime
  nights         Int
  priceBase      Float?
  priceTotal     Float
  currency       String
  paymentType    String?
  cancellation   String?
  latitude       Float?
  longitude      Float?
  isBooked       Boolean       @default(false)
  bookingRef     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  stop           ItineraryStop @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@map("itinerary_hotels")
}

model FlightSegment {
  id              String    @id @default(cuid())
  itineraryId     String
  flightOfferId   String?
  fromCityCode    String
  toCityCode      String
  departureDate   DateTime?
  arrivalDate     DateTime?
  carrierCode     String?
  flightNumber    String?
  duration        String?
  passengers      Int       @default(1)
  priceBase       Float?
  priceTotal      Float
  currency        String
  cabinClass      String?
  isBooked        Boolean   @default(false)
  bookingRef      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  itinerary       Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  @@map("flight_segments")
}

model BudgetSummary {
  id              String    @id @default(cuid())
  itineraryId     String    @unique
  flightsCost     Float     @default(0)
  hotelsCost      Float     @default(0)
  activitiesCost  Float     @default(0)
  totalCost       Float     @default(0)
  currency        String    @default("USD")
  lastCalculated  DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  itinerary       Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  @@map("budget_summaries")
}
